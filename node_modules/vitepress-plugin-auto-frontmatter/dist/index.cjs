"use strict";Object.defineProperty(exports,"__esModule",{value:!0});const vite=require("vite"),node_path=require("node:path"),tinyglobby=require("tinyglobby"),y=require("gray-matter"),node_fs=require("node:fs"),e=require("picocolors");function _interopDefaultCompat(t){return t&&typeof t=="object"&&"default"in t?t.default:t}const y__default=_interopDefaultCompat(y),e__default=_interopDefaultCompat(e);function formatDate(t,n="yyyy-MM-dd hh:mm:ss"){t instanceof Date||(t=new Date(t));const r={"M+":t.getMonth()+1,"d+":t.getDate(),"h+":t.getHours(),"m+":t.getMinutes(),"s+":t.getSeconds(),"q+":Math.floor((t.getMonth()+3)/3),S:t.getMilliseconds()};/(y+)/.test(n)&&(n=n.replace(RegExp.$1,`${t.getFullYear()}`.substr(4-RegExp.$1.length)));for(const o in r)new RegExp(`(${o})`).test(n)&&(n=n.replace(RegExp.$1,RegExp.$1.length===1?r[o]:`00${r[o]}`.substr(`${r[o]}`.length)));return n}const version="1.0.11",logger=vite.createLogger("info",{prefix:`[vitepress-plugin-auto-frontmatter v${version}]`}),info=(t,n="green",r={timestamp:!0})=>{logger.info(e__default[n](t),r)},warn=(t,n="yellow",r={timestamp:!0})=>{logger.warn(e__default[n](t),r)},warnOnce=(t,n="yellow",r={timestamp:!0})=>{logger.info(e__default[n](t),r)},error=(t,n="red",r={timestamp:!0})=>{logger.error(e__default[n](t),r)},$={info,warn,warnOnce,error};function R(t={}){let n=!1;return{name:"vitepress-plugin-auto-frontmatter",async config(r){if(n)return;n=!0;let{pattern:o}=t;if(!o)return;const{globOptions:s}=t,{srcDir:a}=r.vitepress;typeof o=="string"&&(o=[o]),o=o.map(i=>vite.normalizePath(node_path.join(a,i)));const d=await tinyglobby.glob(o,{expandDirectories:!1,...s,absolute:!0,ignore:["**/node_modules/**","**/dist/**",...s?.ignore||[]]});T(d,t,a)}}}const T=(t,n,r)=>{const{include:o,exclude:s,transform:a,recoverTransform:d=!1}=n;for(const i of t){if(!i.endsWith(".md"))continue;const h=node_fs.readFileSync(i,"utf-8"),{data:c,content:b}=y__default(h);if(c.layout==="home"||!checkExcludeAndInclude(c,{exclude:s,include:o}))continue;let l={...c},g=!1;const p=node_fs.statSync(i),x={title:getMdFileTitle(node_path.basename(i)),date:p.birthtime||p.atime};for(const[f,M]of Object.entries(x))c[f]===void 0&&(l={[f]:M,...l},g=!0);const m=a?.(l,getFileInfo(r,i));if(!g&&!m)continue;const u=m||l;if(u.date=formatDate(l.date),!d&&Object.keys(u).every(f=>c[f]!==void 0))continue;const v=Object.keys(u).length?y__default.stringify("",u).replace(/'/g,"").replace(/(?:\r?\n)$/,""):"";node_fs.writeFileSync(i,`${v}${b}`),$.info(`'${i}' has been successfully written to frontmatter. (\u6210\u529F\u5199\u5165 frontmatter)`)}},checkExcludeAndInclude=(t,{exclude:n,include:r})=>{if(r&&!Object.keys(t).length)return!1;if(n||r){for(const[o,s]of Object.entries(t))if(n?.[o]===s||r?.[o]!==s)return!1}return!0},getMdFileTitle=t=>{let n="";const r=t.split(".");if(r.length===2)n=r[0];else{const o=t.indexOf("."),s=t.lastIndexOf(".");n=t.substring(o+1,s)}return n},getFileInfo=(t,n)=>{const r=node_path.resolve(t),o=node_path.resolve(n),s=node_path.relative(r,o).replace(/\\/g,"/");return{filePath:n,relativePath:s}};exports.checkExcludeAndInclude=checkExcludeAndInclude,exports.default=R,exports.getFileInfo=getFileInfo,exports.getMdFileTitle=getMdFileTitle;
